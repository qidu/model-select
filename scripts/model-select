#!/bin/bash

# model-select skill for Claude Code

set -e

CONFIG_DIR="$HOME/.claude"
CLAUDE_SETTINGS="$CONFIG_DIR/settings.json"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=== Claude Model Select ===${NC}\n"

check_jq() {
    if ! command -v jq &> /dev/null; then
        echo -e "${RED}Error: jq is required.${NC}"
        if command -v brew &> /dev/null; then
            echo -e "Install with: ${GREEN}brew install jq${NC}"
        elif command -v apt-get &> /dev/null; then
            echo -e "Install with: ${GREEN}sudo apt install jq${NC}"
        elif command -v choco &> /dev/null; then
            echo -e "Install with: ${GREEN}choco install jq${NC}"
        elif command -v winget &> /dev/null; then
            echo -e "Install with: ${GREEN}winget install jqlang.jq${NC}"
        else
            echo -e "Please install jq manually: https://stedolan.github.io/jq/download.html"
        fi
        exit 1
    fi
}

get_api_key() {
    echo "${ANTHROPIC_API_KEY:-${ANTHROPIC_AUTH_TOKEN:-}}"
}

check_api_key() {
    local api_key=$(get_api_key)
    if [ -z "$api_key" ]; then
        echo -e "${YELLOW}No API key found. Set: export ANTHROPIC_API_KEY='your-key'${NC}"
        return 1
    fi
    echo -e "${GREEN}API key found.${NC}"
    return 0
}

fetch_models() {
    local api_key=$(get_api_key)
    if [ -z "$api_key" ]; then
        echo -e "${YELLOW}Cannot fetch models without API key.${NC}"
        return 1
    fi
    echo -e "${BLUE}Fetching models from Anthropic API...${NC}"
    local response
    if response=$(curl -s --fail -H "x-api-key: $api_key" \
        -H "anthropic-version: 2023-06-01" \
        "https://api.anthropic.com/v1/models" 2>&1); then
        if [ -n "$response" ]; then
            echo "$response" | jq -r '.data[] | "\(.id) - \(.display_name // .id)"' 2>/dev/null || echo "$response"
        else
            echo -e "${YELLOW}No models returned from API.${NC}"
            show_known_models
        fi
    else
        echo -e "${YELLOW}API request failed. Using known models list.${NC}"
        show_known_models
    fi
}

show_known_models() {
    cat <<EOF
claude-opus-4-0 - Claude Opus 4 (Most Capable)
claude-sonnet-4-0 - Claude Sonnet 4 (Balanced)
claude-haiku-3-5-2025-02-20 - Claude Haiku (Fast)
EOF
}

show_current_settings() {
    echo -e "${BLUE}Current Settings:${NC}"
    if [ -f "$CLAUDE_SETTINGS" ]; then
        jq -r 'to_entries | .[] | "\(.key): \(.value)"' "$CLAUDE_SETTINGS" 2>/dev/null || echo "Could not parse"
    else
        echo "Settings file not found"
    fi
    echo ""
}

set_model() {
    local model="$1"
    mkdir -p "$CONFIG_DIR"
    if [ -f "$CLAUDE_SETTINGS" ]; then
        jq --arg model "$model" '.model = $model' "$CLAUDE_SETTINGS" > "${CLAUDE_SETTINGS}.tmp" && mv "${CLAUDE_SETTINGS}.tmp" "$CLAUDE_SETTINGS"
    else
        echo "{\"model\": \"$model\"}" > "$CLAUDE_SETTINGS"
    fi
    echo -e "${GREEN}Model set to: $model${NC}"
}

check_jq

case "${1:-}" in
    "check"|"status")
        check_api_key
        show_current_settings
        ;;
    "models"|"list")
        fetch_models
        ;;
    "set")
        [ -z "${2:-}" ] && { echo "Usage: model-select set <model>"; fetch_models; } || set_model "$2"
        ;;
    "current"|"now")
        [ -f "$CLAUDE_SETTINGS" ] && jq -r '.model' "$CLAUDE_SETTINGS" || echo "claude-sonnet-4-0 (default)"
        ;;
    "help"|"--help"|"-h")
        cat <<EOF
Claude Model Select Skill

Usage: model-select [command]

Commands:
  check, status    - Check API key and show settings
  models, list     - List available models
  set <model>      - Set active model
  current, now     - Show current model
  help             - Show this help
EOF
        ;;
    "")
        show_current_settings
        echo "Use 'model-select help' for usage"
        ;;
    *)
        echo "Unknown: $1. Use 'model-select help'"
        ;;
esac
